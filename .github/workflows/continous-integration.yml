name: Continous Integration
on: [push, pull_request]
jobs:
  run-tests:
    name: Run PHPUnit tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v2
      
      - name: Login to GitHub's docker registry
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u $GITHUB_ACTOR --password-stdin
      
      - name: Copy sample.env to .env
        run: cp sample.env .env
      
      - name: Pull docker images
        run: (docker pull docker.pkg.github.com/$GITHUB_REPOSITORY/tarallo-app && docker pull docker.pkg.github.com/$GITHUB_REPOSITORY/tarallo-web && docker pull docker.pkg.github.com/$GITHUB_REPOSITORY/tarallo-db) || true

      - name: Test
        run: docker image ls

      - name: Build and start the containers
        run: make ci
      
      - name: Run the tests inside the container
        run: docker-compose exec -T app php vendor/phpunit/phpunit/phpunit --configuration phpunit.xml
      
      - name: Push docker images
        run: docker tag tarallo-app docker.pkg.github.com/$GITHUB_REPOSITORY/tarallo-app
      - run: docker push docker.pkg.github.com/$GITHUB_REPOSITORY/tarallo-app || true
      - run: docker tag tarallo-db docker.pkg.github.com/$GITHUB_REPOSITORY/tarallo-db
      - run: docker push docker.pkg.github.com/$GITHUB_REPOSITORY/tarallo-db || true
      - run: docker tag tarallo-web docker.pkg.github.com/$GITHUB_REPOSITORY/tarallo-web
      - run: docker push docker.pkg.github.com/$GITHUB_REPOSITORY/tarallo-web || true